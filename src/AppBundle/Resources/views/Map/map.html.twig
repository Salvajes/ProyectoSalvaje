{% extends "AppBundle::base.html.twig" %}

{%  block main %}

    <link rel="stylesheet" href="{{ asset('bundles/app/css/leaflet.css') }}">
    <link rel="stylesheet" href="{{ asset('bundles/app/css/leaflet.label.css') }}">
    <link rel="stylesheet" href="{{ asset('bundles/app/css/MarkerCluster.css') }}">
    <link rel="stylesheet" href="{{ asset('bundles/app/css/MarkerCluster.Default.css') }}">
    <link rel="stylesheet" href="{{ asset('bundles/app/css/map-style.css') }}">
    <link rel="stylesheet" href="{{ asset('bundles/app/css/leaflet-search.css') }}">

    <div id="mapCanvas">
        <div id="ghost" style="background: transparent; position: absolute; z-index: 1001; bottom: 0;right: 0;width: 139px; height: 16px;"></div>
    </div>

{% endblock %}

{% block script %}

    <script src="{{ asset('bundles/app/js/leaflet.js') }}"></script>
    <script src="{{ asset('bundles/app/js/leaflet.label.js') }}"></script>
    <script src="{{ asset('bundles/app/js/leaflet.markercluster-src.js') }}"></script>
    <script src="{{ asset('bundles/app/js/leaflet-search.js') }}"></script>

    <script>

        /**
         * Mapa.
         */
        var map;
        var tile;


        $(document).ready(function(){

            /**
             * Inicializa mapa.
             */
            map  = L.map('mapCanvas').setView([23.1283279, -101.6752951], 4 );

            tile = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            var marker = new L.marker(
                    [23.1283279, -101.6752951],
                    {draggable: true}
            ).addTo(map);

            var search = new L.Control.Search({
                url: 'http://nominatim.openstreetmap.org/search?format=json&q={s}',
                jsonpParam: 'json_callback',
                propertyName: 'display_name',
                propertyLoc: ['lat','lon'],
                circleLocation: false,
                markerLocation: false,
                autoType: false,
                autoCollapse: true,
                minLength: 2,
                zoom:10,
                textPlaceholder: 'Buscar...'
            });

            map.addControl(search);

            search.on('search_locationfound', function(e) {
                latitude = e.latlng.lat;
                longitude = e.latlng.lng;
                marker.setLatLng([Number(latitude), Number(longitude)]);
                map.setView([Number(latitude), Number(longitude)], 11);
                console.log("search",[Number(latitude), Number(longitude)]);
            });

            marker.on('dragend', function(e){
                latitude = this.getLatLng().lat;
                longitude =this.getLatLng().lng;
                map.setView([Number(latitude), Number(longitude)], 11);
                console.log("mover",[Number(latitude), Number(longitude)]);
            });

        });


    </script>

{% endblock %}